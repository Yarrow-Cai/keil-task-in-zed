# keil-task-in-zed

# Zed-Keil-集成编译环境 使用说明

## 简介

本工具集旨在将 Keil C51/MDK-ARM 的编译、烧录和清理功能无缝集成到 Zed 编辑器中，让你无需离开 Zed 即可完成嵌入式项目的主要操作。

它通过 Zed 的"任务(Tasks)"功能调用批处理脚本，实现了项目文件的自动查找和命令的自动执行。

---

## 快速开始

### 步骤 1: 一次性配置 Keil 路径

这是 **最重要** 的一步，只需设置一次。

1.  用文本编辑器打开 `.zed` 文件夹中的 `keil_task.bat` 文件。
2.  找到文件顶部的这一行：
    ```batch
    SET KEIL_PATH=D:\Program Files\ARM\MDK5\UV4\UV4.exe
    ```
3.  将等号 `=` 后面的路径替换为你自己电脑上 Keil 的 `UV4.exe` 或 `UV5.exe` 的 **真实、完整** 的安装路径。

### 步骤 2: 在你的项目中使用

1.  将整个 `.zed` 文件夹复制到你 **任何一个** Keil 工程的根目录下。
2.  用 Zed 编辑器打开这个工程文件夹。

### 步骤 3: 运行任务

1.  在 Zed 中，按下快捷键 `Ctrl + Shift + P` 打开命令面板。
2.  输入 `Tasks: Run` 并回车，此时会显示出所有可用的任务。
3.  选择你想要执行的任务：
    *   `Keil: 编译 (自动查找)`: 增量编译你的项目。
    *   `Keil: 重新编译 (自动查找)`: 完全重新编译你的项目。
    *   `Keil: 烧录 (自动查找)`: 编译并烧录程序到目标硬件。
    *   `Keil: 清理 (Clean)`: 清理编译过程中产生的临时文件。
    *   `Keil: clangd 配置与 compile_commands 生成`: 为 Zed 配置 clangd 语言服务器。
    *   `Keil: 生成 .gitignore 文件`: 自动生成适合 Keil 项目的 .gitignore 文件。
    *   `Keil: 转换所有 C/H 文件为 UTF-8`: 批量转换项目中的源文件编码为 UTF-8。

---

## 7大核心功能

### 1. 无缝编译集成
- **自动项目查找**: 自动在当前目录及子目录中查找 `.uvprojx` 或 `.uvproj` 文件
- **完整编译支持**: 支持增量编译、完全重新编译和烧录操作
- **实时输出显示**: 在 Zed 中直接显示 Keil 编译器的完整输出

### 2. 智能代码补全
- **自动生成 clangd 配置**: 针对嵌入式开发优化的配置选项
- **编译命令生成**: 使用 keil2clangd 工具生成真实的编译命令数据库
- **语法检查**: 实时显示语法错误和警告，减少低级错误

### 3. 版本控制优化
- **自动生成 .gitignore**: 包含常见的 Keil 中间文件和临时文件
- **多IDE支持**: 同时忽略 VSCode、JetBrains、AI工具等配置文件
- **团队协作**: 统一的忽略规则，避免提交不必要文件

### 4. 编码问题解决
- **批量UTF-8转换**: 一键将所有 `.c` 和 `.h` 文件转换为 UTF-8 编码
- **中文注释支持**: 解决中文注释在不同系统下的乱码问题
- **跨平台兼容**: 确保代码在不同操作系统下正确显示

### 5. 错误诊断与日志
- **详细错误信息**: 捕获并显示完整的编译错误和警告
- **日志文件保存**: 自动保存编译日志到 `keil_build_log.txt`
- **问题溯源**: 便于定位和分析编译问题

### 6. 项目管理辅助
- **多项目支持**: 当存在多个项目文件时提供选择界面
- **配置验证**: 自动检查 Keil 安装路径和项目文件有效性
- **路径处理**: 智能处理各种路径格式和特殊情况

### 7. 扩展性设计
- **模块化结构**: 每个功能独立，便于单独使用和维护
- **易于定制**: 可以通过修改 `tasks.json` 添加自定义任务
- **开源贡献**: 欢迎社区贡献代码和功能建议

---

## 原理简介

*   `.zed/tasks.json`: Zed 任务的定义文件。它告诉 Zed 命令面板中有哪些任务，以及每个任务应该执行什么命令。
*   `.zed/keil_task.bat`: 核心功能脚本。它会自动查找项目中的 `.uvprojx` 或 `.uvproj` 文件，并根据任务传来的参数（`build`, `flash` 等）调用 Keil 执行相应操作，同时捕获并显示 Keil 的原生输出。
*   `.zed/keilkilll.bat`: 一个简单的清理脚本，用于删除 Keil 编译产生的各种中间文件。
*   `.zed/clangd_config.bat`: clangd 配置脚本，自动生成 `.clangd` 和 `compile_commands.json` 文件。
*   `.zed/gitignore_config.bat`: .gitignore 生成脚本，创建适合 Keil 项目的 Git 忽略规则。
*   `.zed/keil_utf8conv.bat`: 编码转换脚本，将项目中的源文件转换为 UTF-8 编码。

---

## 常见问题解答

**问：任务执行失败，输出 `[ERROR] Keil 程序未在 "..." 找到`？**

**答：** 这是最常见的问题。请回到 **[步骤 1](#步骤-1-一次性配置-keil-路径)**，仔细检查并确保你在 `keil_task.bat` 文件中设置的 `KEIL_PATH` 路径是完全正确的。

**问：使用 clangd 配置后代码补全仍有问题？**

**答：** 自动生成的 `compile_commands.json` 是一个模板，可能需要根据你的项目实际配置进行调整。你可以手动编辑该文件，添加项目特定的编译标志和包含路径。

**问：UTF-8 编码转换后出现乱码？**

**答：** 如果原始文件不是 ANSI 编码，转换可能会出现问题。建议在转换前备份原始文件，或使用版本控制系统管理变更。如果出现问题，可以从备份恢复或使用文本编辑器手动调整编码。

---

## 资源链接

- **项目主页**: [GitHub - keil-task-in-zed](https://github.com/Yarrow-Cai/keil-task-in-zed)
- **Zed 编辑器官网**: [zed.dev](https://zed.dev/)
- **clangd 文档**: [clangd.llvm.org](https://clangd.llvm.org/)
- **Keil MDK 官方文档**: [developer.arm.com](https://developer.arm.com/tools-and-software/embedded/keil-mdk)
