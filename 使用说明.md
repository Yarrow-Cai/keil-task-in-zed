# Zed-Keil-集成编译环境 使用说明

## 简介

本工具集旨在将 Keil C51/MDK-ARM 的编译、烧录和清理功能无缝集成到 Zed 编辑器中，让你无需离开 Zed 即可完成嵌入式项目的主要操作。

它通过 Zed 的“任务(Tasks)”功能调用批处理脚本，实现了项目文件的自动查找和命令的自动执行。

---

## 快速开始

### 步骤 1: 一次性配置 Keil 路径

这是 **最重要** 的一步，只需设置一次。

1.  用文本编辑器打开 `.zed` 文件夹中的 `keil_task.bat` 文件。
2.  找到文件顶部的这一行：
    ```batch
    SET KEIL_PATH=D:\Program Files\ARM\MDK5\UV4\UV4.exe
    ```
3.  将等号 `=` 后面的路径替换为你自己电脑上 Keil 的 `UV4.exe` 或 `UV5.exe` 的 **真实、完整** 的安装路径。

### 步骤 2: 在你的项目中使用

1.  将整个 `.zed` 文件夹复制到你 **任何一个** Keil 工程的根目录下。
2.  用 Zed 编辑器打开这个工程文件夹。

### 步骤 3: 运行任务

1.  在 Zed 中，按下快捷键 `Ctrl + Shift + P` 打开命令面板。
2.  输入 `Tasks: Run` 并回车，此时会显示出所有可用的任务。
3.  选择你想要执行的任务：
    *   `Keil: 编译 (自动查找)`: 增量编译你的项目。
    *   `Keil: 重新编译 (自动查找)`: 完全重新编译你的项目。
    *   `Keil: 烧录 (自动查找)`: 编译并烧录程序到目标硬件。
    *   `Keil: 清理 (Clean)`: 清理编译过程中产生的临时文件。

---

## 原理简介

*   `.zed/tasks.json`: Zed 任务的定义文件。它告诉 Zed 命令面板中有哪些任务，以及每个任务应该执行什么命令。
*   `.zed/keil_task.bat`: 核心功能脚本。它会自动查找项目中的 `.uvprojx` 或 `.uvproj` 文件，并根据任务传来的参数（`build`, `flash` 等）调用 Keil 执行相应操作，同时捕获并显示 Keil 的原生输出。
*   `.zed/keilkilll.bat`: 一个简单的清理脚本，用于删除 Keil 编译产生的各种中间文件。
*   `.zed/keil_utf8conv.bat`: UTF-8编码转换工具。用于将项目中的 `.c` 和 `.h` 文件批量转换为 UTF-8 编码。

### 编码转换注意事项
- `.zed/keil_utf8conv.bat` 工具会将所有 `.c` 和 `.h` 文件转换为 UTF-8 编码
- **可能出现乱码风险**：如果原始文件不是 ANSI 编码或已损坏，转换后可能出现乱码
- **建议转换前备份**：在执行转换操作前，建议先备份原始文件，或使用版本控制工具管理
- **解决方案**：如果出现乱码，可以将备份的原始文件替换回来，或使用文本编辑器手动调整编码

---

## 常见问题解答

### 关于任务执行失败
**问：任务执行失败，输出 `[ERROR] Keil 程序未在 "..." 找到`？**

**答：** 这是最常见的问题。请回到 **[步骤 1](#步骤-1-一次性配置-keil-路径)**，仔细检查并确保你在 `keil_task.bat` 文件中设置的 `KEIL_PATH` 路径是完全正确的。

---

### 关于clangd配置报错
**问：使用clangd时出现很多错误和警告？**

**答：** 这通常是因为clangd缺少正确的编译信息。你可以采取以下措施：

1. **确保生成了正确的 `.clangd` 配置**：
   - 运行 `Keil: clangd 自动配置` 任务来生成初始配置
   - 该任务会创建 `.clangd` 和 `compile_commands.json` 文件

2. **更新 `compile_commands.json`**：
   - 自动生成的 `compile_commands.json` 是一个模板，缺少实际项目信息
   - 对于 Keil MDK 5.30+ 用户，可以在 Keil 中启用 "Generate compiler command line file" 功能
   - 或者手动编辑该文件，添加项目实际的编译命令和包含路径

3. **配置中忽略的警告**：
   - 默认配置已经忽略了一些与 Keil 编译器兼容的常见警告
   - 如果还有其他警告，可以编辑 `.clangd` 文件添加更多的忽略规则

4. **示例：添加更多包含路径**：
   ```yaml
   CompileFlags:
     Add: -I".", -I"./inc", -I"./include", -I"D:\Keil\ARM\CMSIS\Include"
   ```

---

### 关于UTF-8编码转换
**问：使用编码转换工具后出现乱码？**

**答：** 请参考前面的 **[编码转换注意事项](#编码转换注意事项)**。如果出现乱码，建议：
- 立即将备份的原始文件替换回来
- 或使用支持多种编码的文本编辑器手动调整文件编码
